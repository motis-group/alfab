name: Deploy Costing App

on:
  push:
    branches:
      - main
    paths:
      - 'web-app/**'
      - '.github/workflows/**'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'web-app/package.json'

      - name: Install dependencies
        working-directory: web-app
        run: npm install

      - name: Build NextJS app
        working-directory: web-app
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}

      - name: Install sshpass
        run: sudo apt-get install -y sshpass

      - name: Deploy to server
        env:
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_PASSWORD: ${{ secrets.REMOTE_PASSWORD }}
          REMOTE_PATH: /var/www/alfab/
          APP_PATH: web-app
        run: |

          # Stop existing service and clear directory
          sshpass -p $REMOTE_PASSWORD ssh -o StrictHostKeyChecking=no $REMOTE_USER@$REMOTE_HOST "
            sudo systemctl stop nextjs || true
            cd $REMOTE_PATH
            if [ -d .git ]; then
              git reset --hard
              git pull
            else
              cd ..
              sudo rm -rf $REMOTE_PATH/*
              git clone https://github.com/marzella/alfab.git .
            fi
            cd web-app
            npm install --production --no-audit
            npm run build
            sudo chown -R www-data:www-data .
            sudo systemctl restart nextjs || echo 'Warning: Restart service had issues'
          " || echo "Warning: Deployment steps had issues but continuing..."

          # Update service file
          SYSTEMD_SERVICE="[Unit]
          Description=Next.js application
          After=network.target

          [Service]
          Type=simple
          User=www-data
          WorkingDirectory=$REMOTE_PATH/web-app
          ExecStart=/usr/bin/npm start
          Restart=on-failure
          Environment=NODE_ENV=production
          Environment=PORT=10000

          [Install]
          WantedBy=multi-user.target"

          echo "$SYSTEMD_SERVICE" | sshpass -p $REMOTE_PASSWORD ssh -o StrictHostKeyChecking=no $REMOTE_USER@$REMOTE_HOST "sudo tee /etc/systemd/system/nextjs.service"

          # Update nginx configuration
          NGINX_CONFIG="server {
              listen 80;
              server_name alfabvic.com.au 103.125.218.118;
              
              location / {
                  proxy_pass http://localhost:10000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade \$http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host \$host;
                  proxy_cache_bypass \$http_upgrade;
              }

              location /_next/static/ {
                  alias $REMOTE_PATH/web-app/.next/static/;
                  expires 365d;
                  access_log off;
              }
          }"

          echo "$NGINX_CONFIG" | sshpass -p $REMOTE_PASSWORD ssh -o StrictHostKeyChecking=no $REMOTE_USER@$REMOTE_HOST "sudo tee /etc/nginx/sites-available/nextjs"

          # Set permissions and restart services
          sshpass -p $REMOTE_PASSWORD ssh -o StrictHostKeyChecking=no $REMOTE_USER@$REMOTE_HOST "
            set -x  # Enable command echoing for debugging
            sudo chown -R www-data:www-data $REMOTE_PATH
            cd $REMOTE_PATH
            npm install --production --no-audit
            sudo systemctl daemon-reload
            sudo systemctl enable nextjs || echo 'Warning: Enable service had issues'
            sudo systemctl restart nextjs || echo 'Warning: Restart service had issues'
            sudo ln -sf /etc/nginx/sites-available/nextjs /etc/nginx/sites-enabled/ || echo 'Warning: Nginx symlink had issues'
            sudo nginx -t && sudo systemctl restart nginx
          "

          echo "Deployment completed!"
